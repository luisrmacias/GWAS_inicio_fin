##hacemos archivo con lista a fusionar
cd

ls imputados/ -v > imputados/listas/para_fusion.txt
mkdir imputados/listas
##quitamos los eliminados por baja genotipificación
##cat calidad/*.irem | cut -f2 > imputados/listas/a_eliminar.txt
##también quitamos los eliminados
cut -f2 listas/eliminacion_QC/duplicados.txt | head -3 | cat - <(cut -f1 listas/eliminacion_QC/duplicados.txt) > imputados/listas/a_eliminar.txt
##agregamos identificador familiar constante, no se pueden dejar líneas vacías en listado
sed -i -e 's/^/0 /' imputados/listas/a_eliminar.txt

cd imputados
mkdir fusionados
##bcftools concat -f listas/para_fusion.txt -Oz -o fusionados/GEA.vcf.gz
plink --vcf prueba.vcf.gz --const-fid --remove listas/a_eliminar.txt --make-bed --out fusionados_GEA

##paste <(cut -f1,2 -d " " fusionados/GEA.fam) <(cut -f2 -d " " fusionados/GEA.fam | xargs -Ihello grep -w hello ../calidad/GEA_cc.fam | cut -f 1,2 -d " ") > listas/cambio_id_fam.txt
plink --bfile fusionados/GEA --update-ids listas/cambio_id_fam.txt --make-bed --out fusionados/GEA
rm fusionados/*~

##agregamos fenotipo y sexo
awk '$2~/GC/ {$6=1} 1' fusionados_GEA.fam > temp.txt
awk '$2~/GP/ {$6=2} 1' temp.txt > fusionados_GEA.fam

R
load("../../adultos_mega/replica/replica.RData")
ids <- read.table("fusionados_GEA.fam")
muh <- factor(bioquimicos_GEA$Sexo[pmatch(ids$V2, bioquimicos_GEA$id_MA)], labels=c(2,1))
sexos <- cbind(ids[,1:2], muh)
names(sexos) <- c("FID", "IID", "SEX")
sexos$SEX <- as.numeric(levels(sexos$SEX))[sexos$SEX]
sexos$SEX[is.na(sexos$SEX)] <- 0
write.table(sexos, "listas/asignacion_sexo.txt", row.names=FALSE, quote=FALSE)
q()

plink --bfile fusionados_GEA --update-sex listas/asignacion_sexo.txt --make-bed --out fusionados_GEA
plink --bfile fusionados_GEA --geno 0.05 --make-bed --out fusionados_GEA.QC
plink --bfile fusionados_GEA.QC --maf 0.05 --hwe 1e-5 --make-bed --out fusionados_GEA.QC
ls *~
rm *~
##verificamos duplicados y parentezco
plink --bfile fusionados_GEA.QC --genome --out fusionados_GEA.QC
sort -grk10 fusionados_GEA.QC.genome | less

plink --bfile fusionados_GEA.QC --check-sex --out fusionados_GEA.QC
##se elimina un individuo adicional


##de acuerdo a verificación de sexo hecho en etapa anterior de detectan inversiones de identificadores. GC927 y GC926 invertidos. Se cambian estos identificadores
grep -e 927 -e 926 fusionados_GEA.QC.fam | grep GC | cut -f 1,2 -d " " > listas/cambio_ids_invertidos.txt
vim listas/cambio_ids_invertidos.txt
plink --bfile fusionados_GEA.QC --update-ids listas/cambio_ids_invertidos.txt --make-bed --out fusionados_GEA.QC

##tras la corrección de sexo de un individuo y las inversiones anteriores restan 5 individuos a eliminar
vim ../listas/eliminacion_QC/noconcuerdasexo.txt
##guardamos en listas/elim_sexo.txt
vim ../listas/eliminacion_QC/noconcuerdasexo.txt
plink --bfile fusionados_GEA.QC --remove listas/elim_sexo.txt --make-bed --out fusionados_GEA.QC
##repetimos genome y quedó muy bien

##regresamos de cálculo ancestría y componentes
sort -grk10 ancestria/ancestrales_GEA.genome | grep -e GC -e GP | tail -n +6 | head -23 | tr -s [:blank:] "\t" | cut -f2,3 > listas/eliminacion_QC/familiares.txt 


p-link --noweb --bfile imputados/fusionados_GEA.QC --loop-assoc listas/grupos/por_centrogeno.txt --pfilter 1e-9 --out listas/eliminacion_QC/dif_porlote
p-link --noweb --bfile imputados/fusionados_GEA.QC --loop-assoc listas/grupos/por_centrogeno.txt --pfilter 1e-9 --filter-controls --out listas/eliminacion_QC/dif_porlote_controles

cat listas/eliminacion_QC/dif_porlote_controles.[1-4]* | tr -s [:blank:] "\t" | cut -f 3 | sort -u > listas/SNPS/difieren_porcentro.txt

